<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Monitoring Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .dashboard-container { padding: 20px; }
        .status-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            padding: 15px;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-healthy { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        .deployment-item {
            border-left: 3px solid #007bff;
            padding: 10px;
            margin-bottom: 10px;
        }
        .deployment-success { border-left-color: #28a745; }
        .deployment-failed { border-left-color: #dc3545; }
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 15px;
            border-radius: 20px;
            z-index: 1000;
        }
        .aws-instance-card {
            border-left: 4px solid #FF9900;
            margin-bottom: 15px;
        }
        .instance-healthy { border-left-color: #28a745; }
        .instance-warning { border-left-color: #ffc107; }
        .instance-error { border-left-color: #dc3545; }
        .network-metrics {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        .network-metric {
            flex: 1;
            text-align: center;
        }
        .connection-error {
            position: fixed;
            top: 60px;
            right: 20px;
            padding: 8px 15px;
            border-radius: 20px;
            z-index: 1000;
            background-color: #dc3545;
            color: white;
            display: none;
        }
    </style>
</head>
<body class="bg-light">
    <div id="connectionStatus" class="connection-status bg-danger text-white">
        Disconnected
    </div>
    <div id="connectionError" class="connection-error"></div>

    <div class="container-fluid dashboard-container">
        <div class="row">
            <!-- System Metrics -->
            <div class="col-md-4">
                <div class="status-card">
                    <h5>System Metrics</h5>
                    <div id="systemMetrics">
                        <div class="mb-3">
                            <small class="text-muted">CPU Usage</small>
                            <div class="metric-value" id="cpuUsage">-</div>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">Memory Usage</small>
                            <div class="metric-value" id="memoryUsage">-</div>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <small class="text-muted">Disk Usage</small>
                            <div class="metric-value" id="diskUsage">-</div>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service Status -->
            <div class="col-md-4">
                <div class="status-card">
                    <h5>Service Status</h5>
                    <div id="serviceStatus"></div>
                </div>
            </div>

            <!-- Recent Deployments -->
            <div class="col-md-4">
                <div class="status-card">
                    <h5>Recent Deployments</h5>
                    <div id="deployments"></div>
                </div>
            </div>
        </div>

        <!-- GitHub Activity -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="status-card">
                    <h5>GitHub Activity</h5>
                    <div id="githubActivity" class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Event</th>
                                    <th>Repository</th>
                                    <th>Branch</th>
                                    <th>Author</th>
                                    <th>Timestamp</th>
                                </tr>
                            </thead>
                            <tbody id="githubActivityBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- AWS Resources -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="status-card">
                    <h5>AWS Instances</h5>
                    <div id="awsInstances"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class MonitoringDashboard {
            constructor() {
                this.ws = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 10; // Increased from 5
                this.reconnectDelay = 3000; // Reduced from 5000
                this.connect();
                
                // Add periodic reconnection check
                setInterval(() => {
                    if (!this.ws || this.ws.readyState === WebSocket.CLOSED) {
                        this.connect();
                    }
                }, 5000);
            }

            connect() {
                try {
                    if (this.ws) {
                        this.ws.close();
                    }

                    console.log('Attempting to connect to WebSocket server...');
                    this.ws = new WebSocket('ws://localhost:8080');
                    
                    this.ws.onopen = () => {
                        console.log('WebSocket connection established');
                        this.onConnectionOpen();
                    };

                    this.ws.onclose = (event) => {
                        console.log('WebSocket connection closed:', event);
                        this.onConnectionClose();
                    };

                    this.ws.onmessage = (event) => {
                        try {
                            this.handleMessage(event);
                        } catch (error) {
                            console.error('Error handling message:', error);
                            this.showError('Error processing server message: ' + error.message);
                        }
                    };

                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.showError('Connection error occurred');
                    };
                } catch (error) {
                    console.error('Error creating WebSocket:', error);
                    this.showError('Failed to create WebSocket connection');
                }
            }

            showError(message) {
                const errorDiv = document.getElementById('connectionError');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }

            onConnectionOpen() {
                const statusElement = document.getElementById('connectionStatus');
                statusElement.textContent = 'Connected';
                statusElement.classList.remove('bg-danger');
                statusElement.classList.add('bg-success');
                this.reconnectAttempts = 0;
                
                // Request initial metrics
                console.log('Requesting initial metrics...');
                this.sendMessage({ type: 'get_metrics' });
            }

            onConnectionClose() {
                const statusElement = document.getElementById('connectionStatus');
                statusElement.textContent = 'Disconnected (Retrying...)';
                statusElement.classList.remove('bg-success');
                statusElement.classList.add('bg-danger');

                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    console.log(`Reconnection attempt ${this.reconnectAttempts} of ${this.maxReconnectAttempts}`);
                    setTimeout(() => this.connect(), this.reconnectDelay);
                } else {
                    statusElement.textContent = 'Disconnected (Max retries reached)';
                    this.showError('Maximum reconnection attempts reached. Please refresh the page.');
                }
            }

            handleMessage(event) {
                const data = JSON.parse(event.data);
                
                switch (data.type) {
                    case 'metrics':
                        this.updateMetrics(data.metrics);
                        break;
                    case 'deployment':
                        this.updateDeployments(data);
                        break;
                    case 'github':
                        this.updateGithubActivity(data);
                        break;
                    case 'service':
                        this.updateServiceStatus(data);
                        break;
                    case 'aws_metrics':
                        this.updateAwsMetrics(data);
                        break;
                }
            }

            updateMetrics(metrics) {
                if (metrics.cpu_usage !== undefined) {
                    document.getElementById('cpuUsage').textContent = `${metrics.cpu_usage}%`;
                    document.querySelector('#cpuUsage + .progress .progress-bar').style.width = `${metrics.cpu_usage}%`;
                }
                if (metrics.memory_usage !== undefined) {
                    document.getElementById('memoryUsage').textContent = `${metrics.memory_usage}%`;
                    document.querySelector('#memoryUsage + .progress .progress-bar').style.width = `${metrics.memory_usage}%`;
                }
                if (metrics.disk_usage !== undefined) {
                    document.getElementById('diskUsage').textContent = `${metrics.disk_usage}%`;
                    document.querySelector('#diskUsage + .progress .progress-bar').style.width = `${metrics.disk_usage}%`;
                }
            }

            updateDeployments(data) {
                const deploymentsDiv = document.getElementById('deployments');
                const deploymentHtml = `
                    <div class="deployment-item ${data.status === 'success' ? 'deployment-success' : 'deployment-failed'}">
                        <div class="d-flex justify-content-between">
                            <strong>${data.environment}</strong>
                            <span class="text-muted">${new Date(data.timestamp).toLocaleString()}</span>
                        </div>
                        <div>${data.message}</div>
                    </div>
                `;
                deploymentsDiv.insertAdjacentHTML('afterbegin', deploymentHtml);
            }

            updateGithubActivity(data) {
                const tbody = document.getElementById('githubActivityBody');
                const row = `
                    <tr>
                        <td>${data.event}</td>
                        <td>${data.repository}</td>
                        <td>${data.branch}</td>
                        <td>${data.author}</td>
                        <td>${new Date(data.timestamp).toLocaleString()}</td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('afterbegin', row);
            }

            updateServiceStatus(data) {
                const serviceStatusDiv = document.getElementById('serviceStatus');
                const statusHtml = `
                    <div class="mb-3">
                        <div class="d-flex align-items-center">
                            <span class="status-indicator status-${data.status.toLowerCase()}"></span>
                            <strong>${data.name}</strong>
                        </div>
                        <small class="text-muted d-block">Last updated: ${new Date(data.timestamp).toLocaleString()}</small>
                    </div>
                `;
                serviceStatusDiv.innerHTML = statusHtml;
            }

            updateAwsMetrics(data) {
                const instancesDiv = document.getElementById('awsInstances');
                const metrics = data.metrics;
                const instanceId = data.instanceId;
                
                const statusClass = {
                    'healthy': 'instance-healthy',
                    'warning': 'instance-warning',
                    'error': 'instance-error'
                };

                const instanceHtml = `
                    <div class="status-card aws-instance-card ${statusClass[metrics.status] || ''}" data-instance-id="${instanceId}">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6>Instance: ${instanceId}</h6>
                            <span class="badge ${metrics.status === 'healthy' ? 'bg-success' : 
                                              metrics.status === 'warning' ? 'bg-warning' : 'bg-danger'}">
                                ${metrics.status.toUpperCase()}
                            </span>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <small class="text-muted">CPU Utilization</small>
                                <div class="metric-value">${metrics.cpu.toFixed(2)}%</div>
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" 
                                         style="width: ${metrics.cpu}%" 
                                         aria-valuenow="${metrics.cpu}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">Memory Utilization</small>
                                <div class="metric-value">${metrics.memory.toFixed(2)}%</div>
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" 
                                         style="width: ${metrics.memory}%" 
                                         aria-valuenow="${metrics.memory}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>

                        <div class="network-metrics">
                            <div class="network-metric">
                                <small class="text-muted">Network In</small>
                                <div class="metric-value">${(metrics.network.in / 1024 / 1024).toFixed(2)} MB/s</div>
                            </div>
                            <div class="network-metric">
                                <small class="text-muted">Network Out</small>
                                <div class="metric-value">${(metrics.network.out / 1024 / 1024).toFixed(2)} MB/s</div>
                            </div>
                        </div>
                        
                        <small class="text-muted d-block mt-3">
                            Last updated: ${new Date(data.timestamp).toLocaleString()}
                        </small>
                    </div>
                `;

                // Update or add instance card
                const existingCard = instancesDiv.querySelector(`[data-instance-id="${instanceId}"]`);
                if (existingCard) {
                    existingCard.outerHTML = instanceHtml;
                } else {
                    // Clear any existing cards if this is the first update
                    if (!instancesDiv.hasAttribute('data-initialized')) {
                        instancesDiv.innerHTML = '';
                        instancesDiv.setAttribute('data-initialized', 'true');
                    }
                    instancesDiv.insertAdjacentHTML('beforeend', instanceHtml);
                }
            }

            sendMessage(message) {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    try {
                        this.ws.send(JSON.stringify(message));
                    } catch (error) {
                        console.error('Error sending message:', error);
                        this.showError('Failed to send message to server');
                    }
                } else {
                    console.warn('Cannot send message - WebSocket is not connected');
                }
            }
        }

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Initializing dashboard...');
            window.dashboard = new MonitoringDashboard();
        });
    </script>
</body>
</html>